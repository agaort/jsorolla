<dom-module id="opencga-project">
    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .center {
                margin: auto;
                text-align: justify;
                width: 60%;
            }
        </style>

        <div>
            <h2 class="center">{{project.name}}</h2>
            <br>

            <table class="table table-bordered center">
                <thead>
                <tr class="table-header" style="background-color: #eee">
                    <th>Study</th>
                    <th>Date</th>
                    <th>Files</th>
                    <th>Samples</th>
                    <!--<th>Jobs</th>-->
                    <!--<th>Individuals</th>-->
                </tr>
                </thead>
                <tbody>
                <template is="dom-repeat" items="{{_studies}}">
                    <tr>
                        <td>
                            <a href="#" on-click="fireSelectStudy" data-study="{{item}}">{{item.name}}</a>
                        </td>
                        <td>{{item.creationDate}}</td>
                        <td>{{item.files}}</td>
                        <td>{{item.samples}}</td>
                        <!--<td>{{item.jobs}}</td>-->
                        <!--<td>{{item.individuals}}</td>-->
                    </tr>
                </template>
                </tbody>
            </table>
        </div>
    </template>
    <script>
        Polymer({
            is: 'opencga-project',
            properties: {
                opencgaClient: {
                    type: Object
                },
                project: {
                    type: Object,
                    observer: 'projectChanged'
                },
                _studies: {
                    type: Array
                }
            },
            fireSelectStudy: function (e) {
                e.preventDefault();
                this.fire('study', {study: e.target.dataStudy});
            },
            projectChanged: function() {
                if (typeof this.opencgaClient !== "undefined" && typeof this.project !== "undefined" && Object.keys(this.project).length > 0) {
                    let _this = this;
                    // Obtain the summary of the studies
                    let studyPromises = [];
                    this.project.studies.forEach(function(study) {
                        studyPromises.push(_this.opencgaClient.studies().summary(_this.project.alias + ":" + study.alias));
                    });

                    Promise.all(studyPromises).then(function(responses) {
                        let studies = [];
                        responses.forEach(function (response) {
                            let study = response.response[0].result[0];
                            study.creationDate = _this._formatDate(study.creationDate);
                            studies.push(study);
                        });
                        _this._studies = studies;
                    });
                }
            },
            _formatDate: function(dateStr) {
                return moment(parseInt(dateStr)).format('D MMM YY');
            }
        });
    </script>
</dom-module>