<link rel="import" href="susi-opencga-project-tree.html">
<link rel="import" href="susi-opencga-file-preview.html">
<link rel="import" href="../../../components/new-jso-panel.html">
<link rel="import" href="susi-opencga-folder-list.html">
<dom-module id="opencga-file-upload">
    <style is="custom-style" include="jso-styles">
        #mainmenucontent {
            height: calc(100% - 30px);
            overflow-y: auto;
        }

        /*.maincontent {*/
            /*position: absolute;*/
            /*left: 175px;*/
            /*top: 0;*/
            /*width: calc(100% - 175px);*/
            /*height: 100%;*/
            /*white-space: nowrap;*/
        /*}*/
    </style>
    <template>
        <div>
            <div class="row">
                <div class="col-sm-2" style=" margin-left: 10px">
                    <label>Projects > Studies</label>
                    <br>
                    <div class="row">
                        <div class="col-sm-12">
                            <div id="mainmenucontent">
                                <template is="dom-repeat" items="{{projects}}">
                                    <susi-opencga-project-tree on-clickstudy="handleStudyClick" project="{{item}}">
                                    </susi-opencga-project-tree>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-9">
                    <div class="well row maincontent">
                        <susi-opencga-folder-list id="opencgaFolderList" on-fileselect="handleFileSelect" on-openfolder="handleOpenFolder" on-upload-file="handleUploadFile" on-back="handleBackFolder" on-need-refresh="refreshFolderFiles" on-previewfile="handlePreviewFile" study="{{study}}" folder="{{folder}}" files="{{files}}" mode="{{mode}}" disable-icon-view="{{disableIconView}}">
                        </susi-opencga-folder-list>

                    </div>
                    <div id="botbar" class="horizontal layout center">
                        <div class="flex"></div>
                        <div hidden$="{{!checkFileModeOk(mode,selectedFile)}}" class="jso-btn jso-btn-shdw" style="width:100px;" on-click="handleFileModeOk">
                            OK
                        </div>
                        <content id="customButtons" select=".custom-button"></content>
                    </div>
                    <new-jso-panel modal closable hidden id="filePreviewPanel">
                        <span class="header">
                            <i class="fa fa-eye"></i> File Preview
                        </span>
                        <susi-opencga-file-preview opencga-client={{opencgaClient}} class="container" id="filePreview"></susi-opencga-file-preview>
                    </new-jso-panel>

                    <div style="padding: 10px;height: 530px" class="row">

                        <ul id="FilesViewTabs" class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active"><a href="#uploadTab" role="tab" data-toggle="tab"><i class="fa fa-cloud-upload"></i> Upload</a></li>
                            <li role="presentation"><a href="#createFolderTab" role="tab" data-toggle="tab"><i class="fa fa-folder"></i>+ New</a></li>
                        </ul>
                        <br>
                        <div class="tab-content">
                            <div id="uploadTab" role="tabpanel" class="tab-pane active">
                                    <div>
                                        <form style="height: 300px">
                                            <div class="form-group row">
                                                <label for="inputFile" class="col-sm-2 col-form-label">File</label>
                                                <div class="col-sm-10">
                                                    <input type="file" class="file" id="FileToUpload" style="display:none">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="inputFile">
                                                        <span class="input-group-btn">
                                                            <button class="browse btn btn-primary" type="button">...</button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <fieldset class="form-group row">
                                                <label class="col-form-legend col-sm-2">Type</label>
                                                <div class="col-sm-10">
                                                    <div class="form-check">
                                                        <label class="form-check-label">
                                                            <input class="form-check-input" type="radio" name="bioformat" id="vcf" value="VCF"> VCF
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <label class="form-check-label">
                                                            <input class="form-check-input" type="radio" name="bioformat" id="bam" value="BAM"> BAM
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <label class="form-check-label">
                                                            <input class="form-check-input" type="radio" name="bioformat" id="others"
                                                                   value="Others"> Others
                                                        </label>
                                                    </div>
                                                </div>
                                            </fieldset>

                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label">Path</label>
                                                <div class="col-sm-10">
                                                    <template is="dom-if" if="{{checkStudy(study)}}">
                                                        <input id="pathFile" type="text" class="form-control" value="{{project.alias}}/{{study.alias}}" disabled>
                                                    </template>

                                                </div>
                                            </div>

                                            <div class="form-group row" style="float: right;">
                                                <div class="offset-sm-2 col-sm-10">
                                                    <button type="submit" class="btn btn-primary" on-click="uploadFile"><i class="fa fa-cloud-upload"></i> Upload</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                            </div>
                            <div id="createFolderTab" role="tabpanel" class="tab-pane">
                                <div>
                                    <form id="formNewFolder" style="height: 300px">
                                        <div class="form-group row">
                                            <label for="newFolderName" class="col-sm-2 col-form-label">Name</label>
                                            <div class="col-sm-10">
                                                <input type="text" id="newFolderName" class="form-control" required pattern="[a-zA-Z0-9_-]+">
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">Path</label>
                                            <div class="col-sm-10">
                                                <template is="dom-if" if="{{checkStudy(study)}}">
                                                    <input id="pathFolder" type="text" class="form-control" value="{{project.alias}}/{{study.alias}}" disabled>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="form-group row" style="float: right;">
                                            <div class="offset-sm-2 col-sm-10">
                                                <button type="submit" class="btn btn-primary" on-click="createFolder"><i class="fa fa-folder"></i>+ Create Folder</button>
                                            </div>
                                        </div>
                                        <div id="mensajeFolder"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </template>

</dom-module>
<script>
    Polymer({
        is: "opencga-file-upload",
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Object
                },
                project: {
                    type: Object
                },
                projects: {
                    type: Array,
                    notify: true,
                    observer: 'projectsChanged'
                },
                selectedProject: {
                    type: Object,
                    notify: true,
                    observer: 'selectedProjectChanged'
                },
                selectedFile: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return null;
                    }
                },
                studies: {
                    type: Array
                },
                files: {
                    type: Array,
                    notify: true
                },
                folder: {
                    type: Object,
                    notify: true
                },
                folders: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return []
                    },
                    observer: 'changePath'
                },
                selectedStudy: {
                    type: Object,
                    notify: true,
                    observer: 'selectedStudyChanged'
                },
                bioformats: {
                    type: Array,
                    value: function() {
                        return [];
                    },
                    notify: true
                },
                disableNewProject: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                disableNewStudy: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                disableIconView: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                contentData: {
                    type: String,
                    value: ""
                },
                mode: {
                    type: String,
                    reflectToAttribute: true,
                    value: ""
                },


            },

        ready: function() {
            let _this = this;
            $(document).on('click', '.browse', function(){
                var file = $(this).parent().parent().parent().find('.file');
                file.trigger('click');
            });

            $(document).on('change', '.file', function(){
                $(this).parent().find('.form-control').val($(this).val().replace(/C:\\fakepath\\/i, ''));

                let allowedFiles = [".vcf", ".bam"];
                let fileUpload = $("#inputFile");
                let regex = new RegExp("([a-zA-Z0-9\s_\\.\-:])+(" + allowedFiles.join('|') + ")$");
                if (!regex.test(fileUpload.val().toLowerCase())) {
                    $("#others").prop("checked", true);
                } else {
                    let filePatterns = fileUpload.val().toLowerCase().match(regex);
                    if (filePatterns.length > 1) {
                        switch(filePatterns[filePatterns.length-1]) {
                            case ".vcf":
                                $("#vcf").prop("checked", true);
                                _this.fileType = "VCF";
                                break;
                            case ".bam":
                                $("#bam").prop("checked", true);
                                _this.fileType = "BAM";
                                break;
                            default:
                                _this.fileType = "UNKNOWN"
                        }
                    }
                }
                $("#pathFile").val(_this.project.alias +"/"+_this.study.alias+"/"+fileUpload.val());
            });
            this._setInitialSelection();

//
//            var options = {
//                bootstrap2: false,
//                showTags: true,
//                levels: 5,
//                color: "#428bca",
//                expandIcon: 'glyphicon glyphicon-chevron-right',
//                collapseIcon: 'glyphicon glyphicon-chevron-down',
//                nodeIcon: 'glyphicon glyphicon-bookmark',
//
//                ]
//            };

        },
        changePath: function() {
            if ($(document).isReady) {
                var path = this.project.alias + "/" + this.study.alias;
                for (var i = 0; i < this.folders.length; i++) {
                    path = path + "/" + this.folders[i].name;
                }
                $("#pathFile").val(path);
                $("#pathFolder").val(path);
            }

        },
        checkFileModeOk: function(mode, selectedFile) {
            if (this.enableSelectOk == true) {
                if (mode === 'file' && selectedFile != null && selectedFile.id != null && selectedFile.type == 'FILE') {
                    return true;
                }
                if (selectedFile != null){
                    if(selectedFile.id != null){
                        if(selectedFile.type == 'DIRECTORY'){
                            return true;
                        }
                    }
                }
                if (mode === 'folder' && selectedFile != null && selectedFile.id != null && selectedFile.type == 'DIRECTORY') {
                    return true;
                }
            }
            return false;
        },
        handleFileModeOk: function(e) {
            this.fire('ok-click');
        },
        projectsChanged: function(neo, old) {
            if (this.projects == null || this.projects.length === 0) {
                this.reset();
            }
            this.async(function() {
                this._setInitialSelection();
            }, 100);
        },
        _setInitialSelection: function() {
                if (this.selectedProject == null) {
                    var el = Polymer.dom(this.root).querySelector('susi-opencga-project-tree');
                    this.set('selectedProject', el);
                }
                if (this.selectedProject != null && this.selectedStudy == null) {
                    var el = Polymer.dom(this.selectedProject.root).querySelector('susi-opencga-study-tree');
                    this.set('selectedStudy', el);
                }
                if (this.folder && this.selectedStudy) {
                    this.refreshFolderFiles();
                }
        },
        selectedStudyChanged: function(neo, old) {
            if (old) old.selected = false;
            if (neo) neo.selected = true;

            this.selectedFile = null;
            this.files = [];
            if (neo != null) {
                this._showStudyFolder();
            }
        },
        selectedProjectChanged: function(neo, old) {
            if (old) old.selected = false;
            if (neo) neo.selected = true;
        },
        handleStudyClick: function(e) {
            if (this.selectedStudy !== e.currentTarget.selectedStudy) {
                this.files = [];
            }
            this.set('selectedProject', e.currentTarget);
            this.set('selectedStudy', e.currentTarget.selectedStudy);
        },
        handleFileSelect: function(e) {
            this.selectedFile = e.detail;
            console.log(this.selectedFile);
            this._checkCustomButtons();
        },
        handleOpenFolder: function(e) {
            var me = this;
            this.folder = e.detail;
            this.push('folders', this.folder);
            this.files = [];
            this.refreshFolderFiles();
        },
        refreshFolderFiles: function() {
            var me = this;
            this.loading = true;
            var f = this.files[0];
            this._getFilesInFolder(this.selectedStudy.study.id, this.folder.id, function(files) {
                me.files = files;
                me.loading = false;
                if (me.enableAutoIndex) {
                    if (f.name !== me.files[0].name && me.files[0].index == null && me.files[0].type == "FILE") {
                        me.$.opencgaFolderList._autoIndexfile(me.files[0]);
                    }
                }
                //                console.log(files);
            });
        },
        handleStudyBreadcrum: function(e) {
            this.files = [];
            this._showStudyFolder();
        },
        handleBreadcrumClick: function(e) {
            var me = this;
            this.folder = e.currentTarget.folder;

            while (this.folder !== this.folders[this.folders.length - 1]) {
                this.pop('folders');
            }
            this.files = [];
            this.refreshFolderFiles();
        },
        handleBackFolder: function(e) {
            var me = this;
            this.pop('folders');
            this.files = [];
            if (this.folders.length > 0) {
                this.set('folder', this.folders[this.folders.length - 1]);
                this.refreshFolderFiles();
            } else {
                this._showStudyFolder();
            }
        },
        checkStudy: function(study) {
            return study != null;
        },
        checkStudies: function(studies) {
            return typeof this.study === "undefined" && studies.length > 0;
        },
        uploadFile: function (e) {
            e.preventDefault();

            if (typeof this.study === "undefined" && typeof this.studies !== "undefined" && this.studies != null && this.studies.length > 0) {
                let selectedStudy = $("#studyOptions")[0].value;
                for (let i in this.studies) {
                    if (selectedStudy == this.studies[i].alias) {
                        this.study = this.studies[i];
                        break;
                    }
                }
            }
            if (this.opencgaClient instanceof OpenCGAClient) {
                var path=".";
                if(this.folders.length >0){
                    for(var i= 0; i< this.folders.length; i++){
                        path=path+"/"+ this.folders[i].name;
                    }
                }
                let params = {
                    sid: this.opencgaClient._config.sessionId,
                    studyId: this.study.id,
                    file: $("#FileToUpload").prop('files')[0],
                    fileFormat: this.fileType,
                    bioformat: "NONE",
                    relativeFilePath: path,
                    parents:true,
//                    method:"POST"
                };
                var me = this;
                this.opencgaClient.files().upload(params).then(function (response) {
                    me.refreshFolderFiles();
                });
            }
        },
        createFolder: function (e) {
            e.preventDefault();
            if (typeof this.study === "undefined" && typeof this.studies !== "undefined" && this.studies != null && this.studies.length > 0) {
                let selectedStudy = $("#studyOptions")[0].value;
                for (let i in this.studies) {
                    if (selectedStudy == this.studies[i].alias) {
                        this.study = this.studies[i];
                        break;
                    }
                }
            }

            var me = this;
//            $("#newFolderName").val('');
            if (this.$.formNewFolder.checkValidity()) {
                if (this.opencgaClient instanceof OpenCGAClient) {
                    var path="";
                    if(this.folders.length >0){
                        for(var i= 0; i< this.folders.length; i++){
                            path=path+ this.folders[i].name+"/";
                        }
                    }
                    let params = {
                        sid: this.opencgaClient._config.sessionId,
                        studyId: this.study.id,
//                        folders: this.project.alias +"/"+this.study.alias+"/"+$("#newFolderName").val(),
                        folders: path+$("#newFolderName").val(),
                        parents:true,
                    }
                    this.opencgaClient.files().createFolder(params).then(function (response){
                        console.log(response);
                        if (response.response[0].error === '' || response.response[0].error == null) {
                            $("#mensajeFolder").val('');
                            $("#newFolderName").val('');
                            me.refreshFolderFiles();
                        } else {
                            $("#mensajeFolder").val(response.response[0].error);
                        }
                    });
                }
            } else {
                $("#newFolderName").val('Only letters, numbers or slash(-,_) admitted');
            }
        },
        reset: function() {
            this.set('selectedProject', undefined);
            this.set('selectedStudy', undefined);
            this.set('selectedFile', undefined);
            this.set('folder', undefined);
            this.set('folders', []);
            this.set('files', []);
            this.set('contentData', '');
            this.set('loading', false);
        },
        _showStudyFolder: function() {
            var me = this;
            this.loading = true;
            this._getStudyFolder(this.selectedStudy.study.id, function(folder) {
                me.set('folders', []);
                me.folder = folder;
                me._getFilesInFolder(me.selectedStudy.study.id, me.folder.id, function(files) {
                    me.files = files;
                    me.loading = false;
                    //                    console.log(files);
                });
            });
        },
        _getStudyFolder: function(studyId, callback) {
            var me = this;
            this.message = '';
            var folder;

            if (this.opencgaClient instanceof OpenCGAClient) {
                this.opencgaClient.files().search({
                    sid: this.opencgaClient._config.sessionId,
                    studyId: studyId,
                    name: '.'
                }).then( function(response) {
                    // console.log(response);
                    if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                        folder = response.response[0].result[0];
                        callback(folder);
                    } else {
                        console.log(response.response[0].errorMsg);
                    }
                })
            }
        },
        _getFilesInFolder: function(studyId, folderId, callback) {
            var me = this;
            var files;

            var bfList = [];
            if (this.bioformats > 0) {
                var bfList = ['NONE'];
                for (var i = 0; i < this.bioformats.length; i++) {
                    var bf = this.bioformats[i];
                    bfList.push(bf.value);
                }
            }

            var query = {
                sid: this.opencgaClient._config.sessionId,
                //                    status:'READY,STAGED,MISSING',
                status: 'READY',
                type: 'FILE,DIRECTORY',
                studyId: studyId
            };

            if (bfList > 0 && (this.mode === 'file' || this.mode === 'folder')) {
                query.bioformat = bfList.join(',');
            }


            if (this.opencgaClient instanceof OpenCGAClient) {
                this.opencgaClient.files().list(folderId,query).then(function(response){
                    if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                        files = me._filterFiles(response.response[0].result);
                        //                            files = response.response[0].result;
                        callback(files);
                    } else {
                        console.log(response.response[0].errorMsg);
                    }
                })
            }

        },
        _filterFiles: function(files) {
            var bfList = [];
            for (var i = 0; i < this.bioformats.length; i++) {
                var bf = this.bioformats[i];
                bfList.push(bf.value);
            }

            files.sort(function(a, b) {
                return b.creationDate.localeCompare(a.creationDate);
            });
            var filesFiltered = [];
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                // console.log(file.name + ' ' + file.id);
                // console.log(file);
                if (
                        // file.bioformat == 'ALIGNMENT' &&
                        (
                                file.name.charAt(0) == '.' ||
                                file.name == 'command_line.sh' ||
                                file.name.indexOf('sge_err.job') != -1 ||
                                file.name.indexOf('sge_out.job') != -1 ||
                                Utils.endsWith(file.name, '.annot.json.gz') ||
                                Utils.endsWith(file.name, '.file.json.gz') ||
                                Utils.endsWith(file.name, '.variants.stats.json.gz') ||
                                Utils.endsWith(file.name, '.source.stats.json.gz') ||
                                Utils.endsWith(file.name, '.bam.bai') ||
                                Utils.endsWith(file.name, '.bam.coverage.json.gz') ||
                                Utils.endsWith(file.name, '.bam.mean-coverage.json.gz') ||
                                (file.bioformat == 'VARIANT' && file.format == 'AVRO') ||
                                Utils.endsWith(file.name, '.snappy')
                        )
                ) {
                    continue;
                }

                if (this.mode == 'folder') {
                    if (file.type != 'DIRECTORY') {
                        continue;
                    }
                } else if (this.mode == 'file' && bfList.length > 0) {
                    if (file.type == 'FILE' && bfList.indexOf(file.bioformat) == -1) {
                        continue;
                    }
                }

                filesFiltered.push(file);
            }
            return filesFiltered;
        },

        handlePreviewFile: function(e) {
            this.$.filePreviewPanel.show();
            this.$.filePreview.file = this.selectedFile;
        },
        _checkCustomButtons: function() {
            var els = this.$.botbar.querySelectorAll('.custom-button');
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                var found = false;
                var exts = el.getAttribute('file-ext').split(',');
                for (var j = 0; j < exts.length; j++) {
                    var ext = exts[j];
                    if (Utils.endsWithIgnoreCase(this.selectedFile.name, ext)) {
                        found = true;
                        break;
                    }
                }
                if (found) {
                    el.removeAttribute('hidden');
                } else {
                    el.setAttribute('hidden', '');
                }
            }

        }

    });
</script>
